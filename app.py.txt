import streamlit as st
import requests
from bs4 import BeautifulSoup

# é¡µé¢åŸºç¡€é…ç½®
st.set_page_config(page_title="å…¬ä¼—å·äºŒåˆ›WebåŠ©æ‰‹", layout="centered")
st.title("ğŸ“ å…¬ä¼—å·çˆ†æ¬¾äºŒåˆ› Web åŠ©æ‰‹")

# æ ¸å¿ƒæŠ“å–å‡½æ•°
def get_article_text(url):
    headers = {"User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15"}
    try:
        res = requests.get(url, headers=headers, timeout=10)
        soup = BeautifulSoup(res.text, 'html.parser')
        content = soup.find('div', id='js_content')
        if content:
            return content.get_text(separator='\n', strip=True)
        return None
    except:
        return None

# AIæ”¹å†™é€»è¾‘
def ai_rewrite(text, api_key):
    # æ­¤å¤„å·²å®Œæ•´é›†æˆæ‚¨æä¾›çš„åŸåˆ›æ€§åŠ å¼ºå»ºè®®
    user_prompt = f"""å‡è®¾ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‡ªåª’ä½“ä½œå®¶ã€‚æˆ‘å¸Œæœ›ä½ èƒ½å¯¹ä¸‹æ–¹çš„æ–‡å­—è¿›è¡ŒäºŒæ¬¡åˆ›ä½œï¼Œç¡®ä¿å…¶å…·æœ‰è¾ƒé«˜çš„åŸåˆ›æ€§ã€‚ä¸ºäº†å¸®åŠ©ä½ è¿›è¡Œè¿™é¡¹ä»»åŠ¡ï¼Œè¯·å‚è€ƒä»¥ä¸‹åŸåˆ›æ€§åŠ å¼ºå»ºè®®:
å¥å‹ä¸è¯æ±‡è°ƒæ•´:é€šè¿‡æ›¿æ¢åŸæ–‡ä¸­çš„å¥å­ç»“æ„å’Œè¯æ±‡ä»¥ä¼ è¾¾åŒæ ·çš„æ€æƒ³ã€‚å†…å®¹æ‹“å±•ä¸æ’å…¥:å¢æ·»èƒŒæ™¯çŸ¥è¯†ã€å®ä¾‹ï¼Œä»¥ä¸°å¯Œæ–‡ç« å†…å®¹ï¼Œå¹¶é™ä½å…³é”®è¯å¯†åº¦ã€‚
é¿å…å…³é”®è¯ä½¿ç”¨:é¿å…ä½¿ç”¨åŸæ–‡ä¸­çš„æ˜æ˜¾å…³é”®è¯æˆ–ç”¨å…¶å®ƒè¯æ±‡æ›¿æ¢ã€‚ç»“æ„ä¸é€»è¾‘è°ƒæ•´:é‡æ–°æ’åˆ—æ–‡ç« çš„ç»“æ„å’Œé€»è¾‘æµç¨‹ï¼Œç¡®ä¿ä¸åŸæ–‡çš„ç›¸ä¼¼åº¦é™ä½ã€‚
å˜æ›´å™äº‹è§†è§’:åœ¨æŸäº›æƒ…å¢ƒä¸‹ï¼Œé€‰æ‹©ä½¿ç”¨ç¬¬ä¸‰äººç§°ä»£æ›¿ç¬¬ä¸€äººç§°ä»¥é™ä½é£æ ¼ç›¸ä¼¼æ€§ã€‚
é‡ç‚¹èšç„¦:æ›´æ”¹æ–‡ç« çš„ä¸»è¦è®¨è®ºç‚¹ï¼Œä»¥å‡å°‘æ¨¡ç³ŠåŒ¹é…çš„é£é™©ï¼Œå…³é”®è¯åˆ†æ:å¯¹æ¯”åŸæ–‡å’Œé‡å†™ç‰ˆæœ¬ï¼Œè°ƒæ•´æˆ–ç¨€é‡Šé«˜åº¦ç›¸ä¼¼çš„å…³é”®è¯ã€‚è§’åº¦ä¸ç„¦ç‚¹è½¬æ¢:ä»ä¸åŒçš„è§’åº¦æè¿°ç›¸åŒçš„ä¸»é¢˜ï¼Œä»¥å‡å°‘å†…å®¹ç›¸ä¼¼æ€§ã€‚é¿å…ç›´æ¥å¼•ç”¨:ç¡®ä¿æ²¡æœ‰ç›´æ¥å¤åˆ¶åŸæ–‡æˆ–å…¶ä»–å·²çŸ¥æ¥æºçš„å†…å®¹ï¼Œç»¼åˆæŠ„è¢­æ£€æµ‹åé¦ˆ:æ ¹æ®æä¾›çš„æŠ„è¢­æ£€æµ‹åé¦ˆï¼Œè¿›è¡Œæœ‰é’ˆå¯¹æ€§çš„è°ƒæ•´ã€‚è¯·ä¾ç…§ä¸Šè¿°å»ºè®®ï¼Œæ ¹æ®åŸæ–‡å¼€å§‹ä½ çš„åˆ›ä½œã€‚

æ³¨æ„ï¼š
1. å…ˆç»™å‡º 5 ä¸ªçˆ†æ¬¾æ ‡é¢˜ã€‚
2. ä½¿ç”¨ Markdown æ ¼å¼è¾“å‡ºã€‚

åŸæ–‡=ï¼ˆ{text}ï¼‰"""

    payload = {
        "model": "deepseek-chat",
        "messages": [{"role": "user", "content": user_prompt}]
    }
    headers = {"Authorization": f"Bearer {api_key}"}
    r = requests.post("https://api.deepseek.com/chat/completions", json=payload, headers=headers)
    return r.json()['choices'][0]['message']['content']

# ç•Œé¢å±•ç¤º
target_url = st.text_input("è¯·è¾“å…¥å¾®ä¿¡æ–‡ç« é“¾æ¥")
if st.button("âœ¨ å¼€å§‹ç”ŸæˆäºŒåˆ›å†…å®¹", type="primary"):
    try:
        api_key = st.secrets["DEEPSEEK_API_KEY"]
    except:
        st.error("æœªé…ç½® API Keyï¼Œè¯·åœ¨äº‘ç«¯åå°è®¾ç½® Secretsã€‚")
        st.stop()

    if target_url:
        with st.spinner("DeepSeek æ­£åœ¨å…¨åŠ›æ”¹å†™ä¸­..."):
            raw_text = get_article_text(target_url)
            if raw_text:
                result = ai_rewrite(raw_text, api_key)
                st.markdown("### ğŸ”¥ ç”Ÿæˆç»“æœ")
                st.code(result, language="markdown")
            else:
                st.error("æŠ“å–å†…å®¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥ã€‚")